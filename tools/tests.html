<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HBCE-OIS — Deterministic Tests</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;max-width:980px;margin:24px auto;padding:0 14px;line-height:1.35}
    h1{font-size:20px;margin:0 0 6px}
    p{margin:0 0 10px;color:#222}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
    textarea{width:100%;min-height:240px;padding:10px;border:1px solid #bbb;border-radius:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px}
    button{padding:10px 12px;border:1px solid #111;border-radius:12px;background:#111;color:#fff;cursor:pointer}
    button.secondary{background:#fff;color:#111}
    .box{border:1px solid #bbb;border-radius:12px;padding:12px;margin-top:12px}
    .ok{font-weight:700}
    .bad{font-weight:700}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px}
    code{background:#f2f2f2;padding:2px 5px;border-radius:6px}
    a{color:#111}
  </style>
</head>
<body>
  <h1>HBCE-OIS — Deterministic Tests</h1>
  <p>Loads official test vectors from <code>/tests</code> and verifies integrity locally (fail-closed).</p>

  <div class="row">
    <button id="btnLoadValid">Load VALID Test</button>
    <button id="btnLoadInvalid" class="secondary">Load INVALID Test</button>
    <button id="btnVerify">Verify</button>
    <a class="mono" href="./verifier.html">Open Verifier</a>
  </div>

  <textarea id="input" spellcheck="false"></textarea>

  <div class="box">
    <div>Result: <span id="result" class="mono">—</span></div>
    <div>Computed integrity: <span id="computed" class="mono">—</span></div>
    <div>Stored integrity: <span id="stored" class="mono">—</span></div>
    <div>Notes: <span id="notes" class="mono">—</span></div>
  </div>

<script>
(() => {
  "use strict";
  const $ = (id) => document.getElementById(id);

  function sortKeysDeep(v){
    if (Array.isArray(v)) return v.map(sortKeysDeep);
    if (v && typeof v === "object"){
      const out = {};
      Object.keys(v).sort().forEach(k => { out[k] = sortKeysDeep(v[k]); });
      return out;
    }
    return v;
  }

  function toCanonicalString(obj){
    return JSON.stringify(sortKeysDeep(obj));
  }

  async function sha256Hex(str){
    const enc = new TextEncoder();
    const buf = await crypto.subtle.digest("SHA-256", enc.encode(str));
    const bytes = new Uint8Array(buf);
    return Array.from(bytes).map(b => b.toString(16).padStart(2,"0")).join("");
  }

  function setResult(ok, msg){
    $("result").textContent = msg;
    $("result").className = "mono " + (ok ? "ok" : "bad");
  }
  function setNotes(msg){ $("notes").textContent = msg || "—"; }

  async function verify(){
    $("computed").textContent = "—";
    $("stored").textContent = "—";
    setNotes("");

    let parsed;
    try{ parsed = JSON.parse($("input").value); }
    catch(e){
      setResult(false, "INVALID JSON");
      setNotes(String(e && e.message ? e.message : e));
      return;
    }

    const stored = (parsed && typeof parsed === "object") ? (parsed.integrity || "") : "";
    $("stored").textContent = stored || "—";

    const copy = JSON.parse(JSON.stringify(parsed));
    delete copy.integrity;

    const canonical = toCanonicalString(copy);
    const computed = await sha256Hex(canonical);
    $("computed").textContent = computed;

    if (!stored){
      setResult(false, "MISSING integrity");
      setNotes("IPR has no integrity field.");
      return;
    }

    if (String(stored).toLowerCase() === computed.toLowerCase()){
      setResult(true, "VALID (integrity match)");
      setNotes("Deterministic SHA-256 over canonical JSON without integrity.");
    } else {
      setResult(false, "INVALID (integrity mismatch)");
      setNotes("Computed hash does not match stored integrity. Fail-closed.");
    }
  }

  async function load(path){
    try{
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const txt = await res.text();
      $("input").value = txt;
      setResult(false, "LOADED: " + path);
      setNotes("Click Verify.");
    }catch(e){
      setResult(false, "LOAD FAILED");
      setNotes(path + " — " + String(e && e.message ? e.message : e));
    }
  }

  $("btnLoadValid").addEventListener("click", () => load("../tests/ipr-valid.json"));
  $("btnLoadInvalid").addEventListener("click", () => load("../tests/ipr-invalid.json"));
  $("btnVerify").addEventListener("click", verify);
})();
</script>
</body>
</html>
